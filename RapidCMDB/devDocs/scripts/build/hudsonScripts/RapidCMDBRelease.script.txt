############### tagging svn and checking out the tag #########
#################################################

TAG_NAME="RCMDB_v0_3_2_b"
CURRENT_DATE=$(date +%y%m%d%H)
TAG_NAME=$TAG_NAME$CURRENT_DATE

taglist=`svn list http://dev.ifountain.org/repos/os/tags`
if [ "$taglist" != "${taglist#*$TAG_NAME}" ]
  then
     svn delete -m "Deleting obsolete tag" http://dev.ifountain.org/repos/os/tags/$TAG_NAME
fi

svn mkdir -m "Creating tag $TAG_NAME" http://dev.ifountain.org/repos/os/tags/$TAG_NAME
svn copy http://dev.ifountain.org/repos/os/ThirdParty http://dev.ifountain.org/repos/os/tags/$TAG_NAME -m "Tagging ThirdParty"
svn copy http://dev.ifountain.org/repos/os/RapidModules http://dev.ifountain.org/repos/os/tags/$TAG_NAME -m "Tagging RapidModules"

rm -rf RapidModules
rm -rf ThirdParty
rm -rf Artifacts

svn checkout http://dev.ifountain.org/repos/os/tags/$TAG_NAME/RapidModules ./RapidModules
svn checkout http://dev.ifountain.org/repos/os/tags/$TAG_NAME/ThirdParty ./ThirdParty

############## compiling build scripts ###################
################################################

rm -rf $GROOVY_HOME/build
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/Env.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/Parent.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/Build.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/Test.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/SmartsModuleBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/NetcoolModuleBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidCompBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidCoreBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidExtBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidCmdbBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/SmartsModuleTest.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/CoreModuleTest.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/CompModuleTest.groovy


########################### building ####################
#####################################################

cd RapidModules
groovy RapidCMDB/devDocs/scripts/build/RapidCmdbBuild

mkdir ../Artifacts
mv ../Distribution/*.zip ../Artifacts

#################### running test build and java tests #############
######################################################

groovy RapidCMDB/devDocs/scripts/build/RapidCmdbBuild testBuild
groovy RapidCMDB/devDocs/scripts/build/SmartsModuleTest
groovy RapidCMDB/devDocs/scripts/build/CoreModuleTest
groovy RapidCMDB/devDocs/scripts/build/CompModuleTest


################### generating test domain classes ##############
######################################################

cp ../LicencedJars/lib/jdbc/*.jar ../Distribution/RapidServer/lib
cp ../LicencedJars/lib/smarts/*.jar ../Distribution/RapidServer/lib

scriptFileName1="Sample3Setup"
scriptFileName2="Sample1Setup"
cp RapidCMDB/scripts/$scriptFileName1.groovy ../Distribution/RapidServer/RapidCMDB/scripts
cp RapidCMDB/scripts/$scriptFileName2.groovy ../Distribution/RapidServer/RapidCMDB/scripts

rsbatchInput=input.txt
echo  "/RapidCMDB/script/save?name=$scriptFileName1" >> $rsbatchInput
echo  "/RapidCMDB/script/save?name=$scriptFileName2" >> $rsbatchInput
echo  "/RapidCMDB/script/run/$scriptFileName1" >> $rsbatchInput
echo  "/RapidCMDB/script/run/$scriptFileName2" >> $rsbatchInput

for file in $(find RapidCMDB/scripts -name *Test.groovy)
do
     filename=${file#RapidCMDB/scripts/*}
     echo "$filename"
     cp RapidCMDB/scripts/$filename ../Distribution/RapidServer/RapidCMDB/scripts
     echo "/RapidCMDB/script/save?name=$filename" >> $rsbatchInput
     echo  "/RapidCMDB/script/test?id=$filename" >> $rsbatchInput
done

mv $rsbatchInput ../Distribution/RapidServer/RapidCMDB

cd ../Distribution/RapidServer/RapidCMDB/
export RS_HOME=/root/.hudson/jobs/RapidCMDBRelease/workspace/Distribution/RapidServer
chmod +x *


./rs.sh -start
dataDir=data
loopcount=0
until [ -d $dataDir ]
do
   if [ $loopcount -gt 300 ]
    then
        ./rs.sh -stop
        exit 1
   fi
  sleep 1
  loopcount=$(expr $loopcount + 1)
done
sleep 20
./rsbatch.sh -commandfile RapidCMDB/$rsbatchInput -host localhost -port 12222 -username rsadmin -password changeme

sleep 2
./rs.sh -stop
mv test/reports/*.xml ../../../TestResults

generatedModelsDir=generatedModels
if [ -d $generatedModelsDir ]
  then
      mv generatedModels/grails-app/domain/*.groovy grails-app/domain
  else
      echo "Test models couldnot be generated!!!!"
fi

rm -rf data


#################### running grails tests #####################
######################################################

cp ../../../RapidModules/RapidCMDB/devDocs/RCMDBTest.properties .
./rs.sh -test
rm -rf ../../../TestResults/reports
rm -r test/reports/TESTS-TestSuites.xml
mv test/reports ../../../TestResults
