############### tagging svn and checking out the tag #########
#################################################

TAG_NAME="RCMDB_v0_3_4_b"
CURRENT_DATE=$(date +%y%m%d%H)
TAG_NAME=$TAG_NAME$CURRENT_DATE

taglist=`svn list http://dev.ifountain.org/repos/os/tags`
if [ "$taglist" != "${taglist#*$TAG_NAME}" ]
  then
     svn delete -m "Deleting obsolete tag" http://dev.ifountain.org/repos/os/tags/$TAG_NAME
fi

svn mkdir -m "Creating tag $TAG_NAME" http://dev.ifountain.org/repos/os/tags/$TAG_NAME
svn copy http://dev.ifountain.org/repos/os/ThirdParty http://dev.ifountain.org/repos/os/tags/$TAG_NAME -m "Tagging ThirdParty"
svn copy http://dev.ifountain.org/repos/os/RapidModules http://dev.ifountain.org/repos/os/tags/$TAG_NAME -m "Tagging RapidModules"

rm -rf RapidModules
rm -rf ThirdParty
rm -rf Artifacts

svn checkout http://dev.ifountain.org/repos/os/tags/$TAG_NAME/RapidModules ./RapidModules 
svn checkout http://dev.ifountain.org/repos/os/tags/$TAG_NAME/ThirdParty ./ThirdParty

############## compiling build scripts ###################
################################################

rm -rf $GROOVY_HOME/build
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/Env.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/Parent.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/Build.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/Test.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/SmartsModuleBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/NetcoolModuleBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidCompBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidCoreBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidExtBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidUiPluginBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidSearchForNetcoolBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/RapidCmdbBuild.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/SmartsModuleTest.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/CoreModuleTest.groovy
groovyc -d $GROOVY_HOME/build RapidModules/RapidCMDB/devDocs/scripts/build/CompModuleTest.groovy


######################building####################
###############################################
cd RapidModules/
groovy RapidCMDB/devDocs/scripts/build/RapidCmdbBuild

mkdir ../Artifacts
mv ../Distribution/*.zip ../Artifacts

#################### running test build and java tests #############
######################################################

rm -rf ../TestResults/
mkdir ../TestResults


groovy RapidCMDB/devDocs/scripts/build/RapidCmdbBuild testBuild
#groovy RapidCMDB/devDocs/scripts/build/SmartsModuleTest 
#groovy RapidCMDB/devDocs/scripts/build/CoreModuleTest 
#groovy RapidCMDB/devDocs/scripts/build/CompModuleTest 


################### generating test domain classes ##############
######################################################

cp ../LicencedJars/lib/jdbc/*.jar ../Distribution/RapidServer/lib
cp ../LicencedJars/lib/smarts/*.jar ../Distribution/RapidServer/lib

scriptFileName1="Sample3Setup"
scriptFileName2="Sample1Setup"
cp RapidCMDBModeler/scripts/$scriptFileName1.groovy ../Distribution/RapidServer/RapidCMDBModeler/scripts
cp RapidCMDBModeler/scripts/$scriptFileName2.groovy ../Distribution/RapidServer/RapidCMDBModeler/scripts
cp RapidCMDBModeler/scripts/ModelHelper.groovy ../Distribution/RapidServer/RapidCMDBModeler/scripts

rsbatchInput=input.txt
echo  "/RapidCMDBModeler/script/save?name=$scriptFileName1" >> $rsbatchInput
echo  "/RapidCMDBModeler/script/save?name=$scriptFileName2" >> $rsbatchInput
echo  "/RapidCMDBModeler/script/run/$scriptFileName1" >> $rsbatchInput
echo  "/RapidCMDBModeler/script/run/$scriptFileName2" >> $rsbatchInput

#for file in $(find RapidCMDB/scripts -name *Test.groovy)
#do
#     filename=${file#RapidCMDB/scripts/*}
#     echo "$filename"
#     cp RapidCMDB/scripts/$filename ../Distribution/RapidServer/RapidCMDB/scripts
#     echo "/RapidCMDB/script/save?name=$filename" >> $rsbatchInput
#     echo  "/RapidCMDB/script/test?id=$filename" >> $rsbatchInput
#done

mv $rsbatchInput ../Distribution/RapidServer/RapidCMDBModeler

cd ../Distribution/RapidServer/RapidCMDBModeler/
export RS_HOME=/root/.hudson/jobs/RapidCMDBRelease/workspace/Distribution/RapidServer
chmod +x *

sed -i "s/-Dserver.port=12223/-Dserver.port=9999/g" rsmodeler.sh


./rsmodeler.sh -start
dataDir=data
loopcount=0
until [ -d $dataDir ]
do
   if [ $loopcount -gt 300 ]
     then
        ./rsmodeler.sh -stop
        exit 1
   fi
   sleep 1
   loopcount=$(expr $loopcount + 1)
done
sleep 20

cd ../bin
chmod +x rsbatch.sh
./rsbatch.sh -commandfile RapidCMDBModeler/$rsbatchInput -host localhost -port 12223 -username rsadmin -password changeme
cd ../RapidCMDBModeler

sleep 2
./rsmodeler.sh -stop

if [ -d test/reports ]
 then
   mv test/reports/*.xml ../../../TestResults
fi

cd ..
generatedModelsDir=RapidCMDB/generatedModels
if [ -d $generatedModelsDir ]
  then
      mv $generatedModelsDir/grails-app/domain/*.groovy RapidCMDB/grails-app/domain
  else
      echo "Test models couldnot be generated!!!!"
fi

cd RapidCMDBModeler
rm -rf data


#################### running grails tests #####################
######################################################

cp ../../../RapidModules/RapidCMDB/devDocs/RCMDBTest.properties .
./rsmodeler.sh -test
rm -r test/reports/TESTS-TestSuites.xml
if [ ! -d ../../../TestResults/RapidCMDBModeler ]
  then
    mkdir ../../../TestResults/RapidCMDBModeler
fi
mv test/reports/*.xml ../../../TestResults/RapidCMDBModeler

cd ../RapidCMDB
cp ../../../RapidModules/RapidCMDB/devDocs/RCMDBTest.properties .
chmod +x rs.sh
./rs.sh -test
rm -r test/reports/TESTS-TestSuites.xml
if [ ! -d ../../../TestResults/RapidCMDB ]
  then
    mkdir ../../../TestResults/RapidCMDB
fi
mv test/reports/*.xml  ../../../TestResults/RapidCMDB